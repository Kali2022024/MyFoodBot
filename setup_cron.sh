#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è cron –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–æ–∫ —Ç–∞ —Å—Ç–∞—Ä–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó –∞–Ω–∞–ª—ñ–∑—ñ–≤ —ó–∂—ñ

echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–æ–∫ —Ç–∞ —Å—Ç–∞—Ä–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó –∞–Ω–∞–ª—ñ–∑—ñ–≤ —ó–∂—ñ..."

# –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
CURRENT_DIR=$(pwd)
echo "üìÅ –ü–æ—Ç–æ—á–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è: $CURRENT_DIR"

# –®–ª—è—Ö –¥–æ —Å–∫—Ä–∏–ø—Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è
CLEANUP_SCRIPT="$CURRENT_DIR/subscription_cleanup.py"
echo "üìú –°–∫—Ä–∏–ø—Ç –æ—á–∏—â–µ–Ω–Ω—è: $CLEANUP_SCRIPT"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î —Å–∫—Ä–∏–ø—Ç
if [ ! -f "$CLEANUP_SCRIPT" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –°–∫—Ä–∏–ø—Ç $CLEANUP_SCRIPT –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    echo "üí° –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó"
    exit 1
fi

# –†–æ–±–∏–º–æ —Å–∫—Ä–∏–ø—Ç –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º
chmod +x "$CLEANUP_SCRIPT"
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∑—Ä–æ–±–ª–µ–Ω–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º"

# –°—Ç–≤–æ—Ä—é—î–º–æ cron –∑–∞–≤–¥–∞–Ω–Ω—è (—â–æ–¥–Ω—è –æ 02:00)
CRON_JOB="0 2 * * * cd $CURRENT_DIR && python3 $CLEANUP_SCRIPT >> $CURRENT_DIR/subscription_cleanup.log 2>&1"

echo "‚è∞ –î–æ–¥–∞–≤–∞–Ω–Ω—è cron –∑–∞–≤–¥–∞–Ω–Ω—è..."
echo "üìÖ –ó–∞–≤–¥–∞–Ω–Ω—è –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è —â–æ–¥–Ω—è –æ 02:00"

# –î–æ–¥–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ crontab
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

if [ $? -eq 0 ]; then
    echo "‚úÖ Cron –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
    echo ""
    echo "üìã –ü–æ—Ç–æ—á–Ω—ñ cron –∑–∞–≤–¥–∞–Ω–Ω—è:"
    crontab -l
    echo ""
    echo "üîß –î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ª–æ–≥—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ:"
    echo "   tail -f $CURRENT_DIR/subscription_cleanup.log"
    echo ""
    echo "üóëÔ∏è –î–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è cron –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ:"
    echo "   crontab -e"
    echo "   (–≤–∏–¥–∞–ª—ñ—Ç—å —Ä—è–¥–æ–∫ –∑ $CLEANUP_SCRIPT)"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è cron –∑–∞–≤–¥–∞–Ω–Ω—è!"
    exit 1
fi

echo ""
echo "üéâ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üí° –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—Ç–∏–º–µ –∑–∞—Å—Ç–∞—Ä—ñ–ª—ñ –ø—ñ–¥–ø–∏—Å–∫–∏ —Ç–∞ —Å—Ç–∞—Ä—É —ñ—Å—Ç–æ—Ä—ñ—é –∞–Ω–∞–ª—ñ–∑—ñ–≤ —ó–∂—ñ —â–æ–¥–Ω—è –æ 02:00"
